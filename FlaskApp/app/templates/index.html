<!DOCTYPE HTML> 
<html>
<head>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<link rel = "stylesheet" type="text/css" href ="{{ url_for('static',filename='styles/index.css') }}">
 <script src ="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> 
  <script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/0.10.0/lodash.min.js" type="text/javascript">
	</script>
   <script> 
 $(document).ready(function(){
  // Add smooth scrolling to all links
  $('a[href^="#"]').on('click', function(event) {

      event.preventDefault();

      var hash = this.hash;
      var target = this.hash;
      var $target = $(target);

      $('html, body').animate({
        scrollTop: $(hash).offset().top
      }, 700, 'swing', function(){
          window.location.hash = target;});
  });
});
    // https://www.youtube.com/watch?v=_EGO-d9H184 
    //https://www.w3schools.com/jquery/tryit.asp?filename=tryjquery_eff_animate_smoothscroll
</script>

</head>
<body>

<div class="container">
<div class="parallax">

<header>
    <h1>DublinBikes.</h1>
     <div id="weather"></div>
     
    </header>    
    <main>
    <div id="select"> 
    <div class="wrapper">
    <ul>
        <a href="#map" class="button1"><li>Map View</li></a>
        <a href="#trip" class="button2"><li>Journey Planner</li></a>
        </ul>
       
    </div>
    </div>
    </main>
        <div id="map" style = "width:100%;height:700px;" ></div>

    <div id = 'trip'>
	<p id = 'new'></p>
	<p id = 'graph'></p>
        <form>
            <ul><li>Please input your location: <input id = 'start' type = 'text' placeholder="Search Box"></li>
                <li>Please input the time of your trip (optional): <input id = 'start' type = 'text' placeholder="Search Box"></li>
                <li>Please input the date of your trip (optional): <input id = 'start' type = 'text' placeholder="Search Box"></li>
                </ul>
		 
            <button type="button" id = "check" onclick= "Submit()">Submit</button>
        </form>
  
    </div>
    <p id = 'testing'></p>

    <div id="mapdiv" style = "width:50%;height:400px;" ></div>
    <p id = 'test'></p></div>

    </div>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    
    <script>


        
window.onload=function(infoWeather) {
     // info = session.query(weather.temp, weather.temp_min, weather.temp_max, weather.description, weather.mainDescription, weather.speed, weather.deg, weather.deg, weather.dt_txt, weather.humidity, weather.rain)
    $.getJSON('/current_weather', function(currWeather) {
        var weather = currWeather.current[0];
    var minTemp = currWeather.current[3];

    var add0 = document.getElementById('weather');
    add0.innerHTML = " ";
    add0.innerHTML = "Today's Weather: " + weather[3];
	add0.innerHTML += "<br>Min temp: " + weather[1];
    add0.innerHTML += "<br>Max temp: " + weather[2];

    }) }
    
// http://clubmate.fi/detect-click-with-pure-javascript/      
 
 function myFunction() {
    document.getElementById("trends").style.display = "block";
}
    
    function Submit(){
        document.getElementById('test').innerHTML = " "
        var start = document.getElementById('start').value;
        GetLatlong(start);
    }
   
    function myMap(){
    google.charts.load('current', {'packages':['corechart']});
        var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 13,
        center: {lat: 53.3498, lng: -6.2603}
        });
          
        
        var marker;
        var i;
        var infoWindow = new google.maps.InfoWindow();
	
	$.getJSON('/station_info', function(data) {
        //	$.each(data,  function(index) {
                     
        	for( i = 0; i <103; i++ ) {
	
        var position = new google.maps.LatLng(data.result[i][1], data.result[i][2]);
        var markers = [];
        marker = new google.maps.Circle({
            center: position,
            map: map,
            title: data.result[i][0],
	    strokeColor: '#008000',
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: '#008000',
            fillOpacity: 0.35,
            radius: data.result[i][3]
        });
//	$.getJSON('/station_occupancy?id='+data.result[i][3], function(info){
//        var bikes = info.occupancy[0]
	//marker.setMap(map);

        google.maps.event.addListener(marker, 'click', (function(marker, i) {
            return function(){
//	$.getJSON('/station_occupancy?id='+data.result[i][3], function(info){
//        var bikes = info.occupancy[0]
        
        x = data.result[i];
//        y = info.occupancy;
//        z = marker;
	
                infoWindow.setContent("Station: " + data.result[i][0] + 
                                      "<br> Available Bikes:1"+//+bikes+
                                      " <br> Available Stands: 2"+//+info.occupancy[1]+
                                     '<br> <a href="#graph"><button onclick="displayContent(x, y, z);">Click for occupancy trends</button></a>');
		infoWindow.open(map, this);
               	map.setZoom(14);
                map.setCenter(marker.getCenter());
                //displayContent(data.result[i], info.occupancy, marker);
       
	  }}(marker, i)))//})	
	}
	})
}
      

        //set array of markers in google map object
        //markers.setMap(map); or may map.setMarkers()
      
  	

    function displayContent(arr1, arr2, marker) {

    
 	var loc = arr1[0]
	var stand = arr2[1]
	var bike = arr2[0]
	var id = arr1[3]
    
	//add = document.getElementById('new');
	//add.innerHTML = " ";
	//add.innerHTML += "Location: " + loc + "<br>";
	//add.innerHTML += "There are " + bike + " bikes available and ";
	//add.innerHTML += stand + " stands available at " + loc;
	   
   var data = new google.visualization.DataTable();
            data.addColumn('number','Day');
	
	$.getJSON('/graph_info?id='+id, function(result){
	
	for (var d = 0; d < 7; d++){
		data.addColumn('number',result.day[d]);
			}
	for (var i = 0; i < 24; i++){
		var col = []
		col.push(i)	 
		for (var j = 0; j < 7; j++){
		col.push(result.data[i][j])
		}
         data.addRows([col]);
           }
	 var options = {
                 title: 'Station: ' + arr1[0],
                 vAxis: {title: 'Bikes'},
                 hAxis: {title: 'Time' },
		isStacked: true,
		height: 600,	 	
//		seriesType: 'line'
		}
	
	chart = new google.visualization.AreaChart(document.getElementById('graph'));
        chart.draw(data, options);
  	 })
	}


     function startmap(lat, long, latend, longend){
        
        var locstart = {lat: lat, lng: long};
        var locend = {lat: latend, lng: longend}
        
        var map = new google.maps.Map(document.getElementById('mapdiv'), {
          center: locstart,
          zoom: 12
        });
        
         var directionsDisplay = new google.maps.DirectionsRenderer({
          map: map
        });

        var request = {
          destination: locstart,
          origin: locend,
          travelMode: 'WALKING'
        };

        var directionsService = new google.maps.DirectionsService();
        directionsService.route(request, function(response, status) {
          if (status == 'OK') {
            directionsDisplay.setDirections(response);
          }
        });
        }
        
        //https://developers.google.com/maps/documentation/javascript/examples/directions-simple
    
        
    function GetLatlong(address) {
        var geocoder = new google.maps.Geocoder();
	address += ", Dublin";

        geocoder.geocode({ 'address': address }, function (results, status) {

            if (status == google.maps.GeocoderStatus.OK) {
                var latitude = results[0].geometry.location.lat();
                var longitude = results[0].geometry.location.lng();
                
                distanceChecker(latitude,longitude,address)
            }
            else {
                document.getElementById('test').innerHTML = "Please enter a valid location"
            }
        })};  
        
    function distanceChecker(lat, long, address){
	    $.getJSON('/station_info', function(data) {
		$.each(data,  function(index) {
	    var i;
            var j = 1;
            var location, min
            if (distance(lat,long,data.result[0][1],data.result[0][2]) < distance(lat,long,data.result[1][1],data.result[1][2])){
                min = distance(lat,long,data.result[0][1],data.result[0][2]);
                location = data.result[0][0];
                latend = data.result[0][1];
                longend = data.result[0][2];
		var val = 0
		 }
            else {
                min = distance(lat,long,data.result[1][1],data.result[1][2]);
                location = data.result[1][0];
    		latend = data.result[1][1];
                longend = data.result[1][2];
		var val = 1
	        }
            for (i = 2; i < 103; i++){
                if (min > distance(lat,long,data.result[i][1],data.result[i][2])){
                    min = distance(lat,long,data.result[i][1],data.result[i][2]);
                    location = data.result[i][0];
                    latend = data.result[i][1];
                    longend = data.result[i][2];
		    var val = i
            }}
	var id = data.result[val][3]
	$.getJSON('/station_occupancy?id='+id, function(info){	
            var div = document.getElementById('test');
            div.innerHTML += "The closest location to " + address + " is " + location + ".";
            div.innerHTML += "You are " + min +"km away from " + location + ".<br>";
	    div.innerHTML += "There are " + info.occupancy[0] + " bikes available and " + info.occupancy[1] + " stands available."
            startmap(lat, long, latend, longend)
        
	
	 var data = new google.visualization.DataTable();
            data.addColumn('number','Day');
        $.getJSON('/graph_info?id='+id, function(result){
        for (var d = 0; d < 7; d++){
                data.addColumn('number',result.day[d]);
                        }
        for (var i = 0; i < 24; i++){
                var col = []
                col.push(i)
                for (var j = 0; j < 7; j++){
                col.push(result.data[i][j])
                }
         data.addRows([col]);
           }
	     var options = {
                 title: 'Station: ' + location,
                 vAxis: {title: 'Bikes'},
                 hAxis: {title: 'Time' },
                height: 600,
                seriesType: 'line'
                }
        chart = new google.visualization.ComboChart(document.getElementById('graph'));
        chart.draw(data, options);
         })
	})})
	})
    }
	

        function distance(lat1,lon1,lat2,lon2) {
            var R = 6371; // Radius of the earth in km
            var dLat = deg2rad(lat2-lat1);  // deg2rad below
            var dLon = deg2rad(lon2-lon1);
            var a =
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            var d = R * c; // Distance in km
            var result = Math.round(d*100)/100
            return result;
            }
            function deg2rad(deg) {
                return deg * (Math.PI/180)
            }
</script>
 
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCaLIaggqQb52Url971GbbnWc3XusmTukM&callback=myMap">
</script>  
    </div>
</div>
</body>
</html>
