<!DOCTYPE HTML> 
<html>
<head>
<link rel = "stylesheet" type="text/css" href ="{{ url_for('static',filename='styles/index.css') }}">

</head>
<body>

<header>
    <a href=index.html>HOME</a>
    <a href=index.html>ABOUT</a>
    <div class = 'dropdown'>
    <button class = 'dropbutton'>STATIONS</button>
        <div class = 'dropcontent'>
            <a href = 'index.html'>Plan your Trip</a>
            <a herf = 'index.html'>View Stations</a>
        </div>
    </div>
    <a href=index.html>CONTACT</a>
    
    </header>    
    <main>
   	<img src ="/static/images/DublinPic.jpg" alt='HomePic'>
    </main>
    
    <div id="map" style = "width:100%;height:700px;" ></div>

    <div id = 'trip'>
	<p id = 'new'></p>
        <form>
            <input id = 'start' type = 'text' placeholder="Search Box">
            <!--   <input id = 'stop' type = 'text' placeholder="Search Box"> -->
        </form>
    <button type="button" id = "check" onclick= "Submit()">Submit</button>
    <p id = 'testing'></p>

    </div>    
    
    <div id="mapdiv" style = "width:50%;height:400px;" ></div>
    <p id = 'test'></p>

    <script>
	
    function Submit(){
        
        document.getElementById('test').innerHTML = " "
        //document.getElementById('testing').innerHTML = " "
        
        var start = document.getElementById('start').value;
       // var end  = document.getElementById('stop').value;
        
        GetLatlong(start);
       // GetLatlong(end);
        }   
    
     function myMap() {

	var dublin = [];
        {% for row in rows %}
                dublin.push( ['{{ row.location }}', {{ row.lat }}, {{ row.long }}, {{row.id}}] );
        {% endfor %}

//	{% for dynam in dynamic %}
//		for (var j = 0; j < length.dublin; j++){
//			if ( dublin[j][3] != {{ dynam.id }} ){
//				dublin[j].push( {{ dynam.stands }} );
			//	dublin[j].push( {{ dynam.bikes }} );
//			}
//			else {
//				dublin[j].push( [6] );
//				dublin[j].push( [5] );
//				}
//			}	
//	{% endfor %}	


	var dynamic = [];
	{% for dynam in dynamic %}
                dynamic.push( [{{ dynam.id }}, {{ dynam.stands }}, {{ dynam.bikes }} ] );
        {% endfor %}
        
        var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 13,
        center: {lat: 53.3498, lng: -6.2603}
            
        });
          
        var infoWindow = new google.maps.InfoWindow()
        var marker;
        var i;
          
        for( i = 0; i < dublin.length; i++ ) {
        
        var position = new google.maps.LatLng(dublin[i][1], dublin[i][2]);
        marker = new google.maps.Marker({
            position: position,
            map: map,
            title: dublin[i][0],
            
        });
                   
        google.maps.event.addListener(marker, 'click', (function(marker, i) {
            return function() {
		var j, val;
		for (j = 0; j < dublin.length; j++){
			if (dublin[i][3] == dynamic[j][0]){
				val = j;
				dublin[i].push( dynamic[j][1] );
				dublin[i].push( dynamic[j][2] );
		}}
		
                infoWindow.setContent("Available Bikes: "+ dynamic[val][2]+"<br> Available Stands: "+dynamic[val][1]);
//		document.getElementById('test').innerhtml = i;
		
		infoWindow.open(map, marker); 
                map.setZoom(15);
                map.setCenter(marker.getPosition());
                displayContent(dublin[i]);
            }
        })(marker, i))}
      }
        
     function displayContent(arr){
	
	loc = arr[0]
	stand = arr[4]
	bike = arr[5]
	
	var add = document.getElementById('new');
	add.innerHTML = " ";
	add.innerHTML += "Location: " + loc + "<br>";
	add.innerHTML += "There are " + bike + " bikes availavle and ";
	add.innerHTML += stand + " stands available at " + loc;	
	}

     function startmap(lat, long, latend, longend){
        
        var locstart = {lat: lat, lng: long};
        var locend = {lat: latend, lng: longend}
        
        var map = new google.maps.Map(document.getElementById('mapdiv'), {
          center: locstart,
          zoom: 12
        });
        
         var directionsDisplay = new google.maps.DirectionsRenderer({
          map: map
        });

        var request = {
          destination: locstart,
          origin: locend,
          travelMode: 'WALKING'
        };

        var directionsService = new google.maps.DirectionsService();
        directionsService.route(request, function(response, status) {
          if (status == 'OK') {
            directionsDisplay.setDirections(response);
          }
        });
        }
        
        //https://developers.google.com/maps/documentation/javascript/examples/directions-simple
    
        
    function GetLatlong(address) {
        var geocoder = new google.maps.Geocoder();
	address += ", Dublin";

        geocoder.geocode({ 'address': address }, function (results, status) {

            if (status == google.maps.GeocoderStatus.OK) {
                var latitude = results[0].geometry.location.lat();
                var longitude = results[0].geometry.location.lng();
                
                distanceChecker(latitude,longitude,address)
            }
            else {
                document.getElementById('test').innerHTML = "Please enter a valid location"
            }
        })};  
        
    function distanceChecker(lat, long, address){
            
	    var dublin = [];
        	{% for row in rows %}
                	dublin.push( ['{{ row.location }}', {{ row.lat }}, {{ row.long }}] );
        	{% endfor %}
            
	    var dynamic = [];
        	{% for dynam in dynamic %}
                	dynamic.push( [{{ dynam.id }}, {{ dynam.stands }}, {{ dynam.bikes }} ]);
        	{% endfor %}
 
	    var i;
            var j = 1;
            var location, min
            
            if (distance(lat,long,dublin[0][1],dublin[0][2]) < distance(lat,long,dublin[1][1],dublin[1][2])){
                
                min = distance(lat,long,dublin[0][1],dublin[0][2]);
                location = dublin[0][0];
                latend = dublin[0][1];
                longend = dublin[0][2];
		 }
            else {
                
                min = distance(lat,long,dublin[1][1],dublin[1][2]);
                location = dublin[1][0];
    		latend = dublin[1][1];
                longend = dublin[1][2];
	        }
            
            for (i = 2; i < dublin.length; i++){
                if (min > distance(lat,long,dublin[i][1],dublin[i][2])){
                    min = distance(lat,long,dublin[i][1],dublin[i][2]);
                    location = dublin[i][0];
                    latend = dublin[i][1];
                    longend = dublin[i][2];
            }}
            
            var div = document.getElementById('test');
            div.innerHTML += "The closest location to " + address + " is " + location + ".";
            div.innerHTML += "You are " + min +"km away from " + location + ".<br>";           

            startmap(lat, long, latend, longend)
        }
        
        function distance(lat1,lon1,lat2,lon2) {
            var R = 6371; // Radius of the earth in km
            var dLat = deg2rad(lat2-lat1);  // deg2rad below
            var dLon = deg2rad(lon2-lon1); 
            var a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2); 
            
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            var d = R * c; // Distance in km
            var result = Math.round(d*100)/100
            return result;
            }

            function deg2rad(deg) {
                return deg * (Math.PI/180)
            }    

</script>
 
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCaLIaggqQb52Url971GbbnWc3XusmTukM&callback=myMap">
</script>  

</body>
</html>
