<!DOCTYPE HTML>
<html>
<head>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<link rel = "stylesheet" type="text/css" href ="{{ url_for('static',filename='styles/index.css') }}">

</head>
<body>

<header>
    <a href=index.html>HOME</a>
    <a href=index.html>ABOUT</a>
    <div class = 'dropdown'>
    <button class = 'dropbutton'>STATIONS</button>
        <div class = 'dropcontent'>
            <a href = 'index.html'>Plan your Trip</a>
            <a herf = 'index.html'>View Stations</a>
        </div>
    </div>
    <a href=index.html>CONTACT</a>

    </header>
    <main>
   	<img src ="/static/images/DublinPic.jpg" alt='HomePic'>
    </main>

    <div id="map" style = "width:100%;height:700px;" ></div>

    <div id = 'trip'>
	<p id = 'new'></p>
        <form>
            <input id = 'start' type = 'text' placeholder="Search Box">
            <!--   <input id = 'stop' type = 'text' placeholder="Search Box"> -->
        </form>
    <button type="button" id = "check" onclick= "Submit()">Submit</button>
    <p id = 'testing'></p>
{#        Code that displays graph from pygal#}
        <div id="container" align="left">
        <embed type="image/svg+xml" src={{graph_data|safe}} style='max-width:500px'/>
    </div>

    </div>

    <div id="mapdiv" style = "width:50%;height:400px;" ></div>
    <p id = 'test'></p>

    <canvas id="chart"></canvas>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    
	<p id = result></p>
	
    <script>
   	
    function Submit(){

        document.getElementById('test').innerHTML = " "

        var start = document.getElementById('start').value;

        GetLatlong(start);
        }

     function myMap() {


//     google.charts.load('current', {'packages':['corechart']});

//         function drawChart(marker1, arr1) {
 //            var chartdata =[];

                 {#for (j = 0; j < dynamic.length; j++) {#}
                 {#    if (arr1[0] == dynamic[j][0]) {#}
                 {#        chartdata.push( dynamic[j][0] );#}
                 {#        chartdata.push( dynamic[j][1]);#}
                 {#        chartdata.push( dynamic[j][2] );#}
                 {#    }#}
                 {#}#}


   //          add = document.getElementById('new');



     //        var data = new google.visualization.arrayToDataTable([
       //          ['id', 'bikes', 'stands'],
         //        [locations, bikes, stands]]);
             {#   chartdata]#}
             {#);#}


 //            var options = {
   //              title: 'Station: ' + arr1[0],
     //            curveType: 'function',
       //          legend: {position: 'bottom'} +
         //        marker1.getPosition().toString(),
           //      'width': 400,
//                 'height': 150

       //      };

             {#node = document.createElement('div');#}

         //    chart = new google.visualization.LineChart(document.getElementById('new'));
        //     chart.draw(data, options);

      //   }


        var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 13,
        center: {lat: 53.3498, lng: -6.2603}

        });


        var marker;
        var i;
        var infoWindow = new google.maps.InfoWindow();
	
	$.getJSON('/station_info', function(data) {
        	$.each(data,  function(index) {
                     
        	for( i = 0; i <103; i++ ) {
	
        var position = new google.maps.LatLng(data.result[i][1], data.result[i][2]);
        marker = new google.maps.Marker({
            position: position,
            map: map,
            title: data.result[i][0],

        });
	
	

        google.maps.event.addListener(marker, 'click', (function(marker, i) {
            return function() {


		{#var contentString = '<div id="content">' +#}
         {#           '<div id="stationinfobox">' +#}
         {#           '</div>' +#}
         {#           '<h1 id="firstHeading" class="firstHeading">Station Info</h1>' +#}
         {#           '<div id="bodyContent">' +#}
         {#           '<p>Station ' + dynamic[val][0] + '</p>' + node +#}
         {#           '<canvas id="myChart" width="1600" height="900"></canvas>' +#}
         {#           '<p>The number of bikes available is ' + dynamic[val][2] + '</p><p> Number of available stands is '#}
         {#               + dynamic[val][1] + '</p>'#}
         {#           '</div>' +#}
         {#           '</div>';#}
		{#var infoWindow = new google.maps.InfoWindow({#}
         {#       content: contentString#}
         {#   });#}
	
	$.getJSON('/station_occupancy?id='+data.result[i][3], function(info){

	
                infoWindow.setContent("Available Bikes:"+info.occupancy[0]+" <br> Available Stands: "+info.occupancy[1]);
        	{#infoWindow.setContent(node);#}
		infoWindow.open(map, marker);
                map.setZoom(15);
                map.setCenter(marker.getPosition());
                displayContent(data.result[i], info.occupancy);
         	})
	  }
	
        })(marker, i))}
	})
	})
      }
	
	

     function displayContent(arr1, arr2){

	loc = arr1[0]
	stand = arr2[0]
	bike = arr2[1]

	add = document.getElementById('new');
	add.innerHTML = " ";
	add.innerHTML += "Location: " + loc + "<br>";
	add.innerHTML += "There are " + bike + " bikes available and ";
	add.innerHTML += stand + " stands available at " + loc;
	
        
        var barData = {
            labels : ['Stands', 'Bikes'],
                  
   	datasets : [
     	 {     
            label: loc,
            data : [stand, bike],
          
            backgroundColor: [
       		 'rgba(255, 99, 132, 0.6)',
       		 'rgba(54, 162, 235, 0.6)'
       		 ]
     	 }]
   
	}
	 document.getElementById("chart").innerHTML = "";
	 var mychart = document.getElementById("chart").getContext("2d");
	   	

  	 var LineChartDemo = new Chart(mychart, {
        
        	type: "bar",
        	data: barData,
		options: {
			responsive: true,
			scales: {
        			yAxes: [{
            				ticks: {
                				beginAtZero: true
            					}
        				}]
    				}
			}
 
  	 });
	}


     function startmap(lat, long, latend, longend){

        var locstart = {lat: lat, lng: long};
        var locend = {lat: latend, lng: longend}

        var map = new google.maps.Map(document.getElementById('mapdiv'), {
          center: locstart,
          zoom: 12
        });

         var directionsDisplay = new google.maps.DirectionsRenderer({
          map: map
        });
        var request = {
          destination: locstart,
          origin: locend,
          travelMode: 'WALKING'
        };
        var directionsService = new google.maps.DirectionsService();
        directionsService.route(request, function(response, status) {
          if (status == 'OK') {
            directionsDisplay.setDirections(response);
          }
        });
        }

        //https://developers.google.com/maps/documentation/javascript/examples/directions-simple


    function GetLatlong(address) {
        var geocoder = new google.maps.Geocoder();
	address += ", Dublin";
        geocoder.geocode({ 'address': address }, function (results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
                var latitude = results[0].geometry.location.lat();
                var longitude = results[0].geometry.location.lng();

                distanceChecker(latitude,longitude,address)
            }
            else {
                document.getElementById('test').innerHTML = "Please enter a valid location"
            }
        })};

    function distanceChecker(lat, long, address){

	    $.getJSON('/station_info', function(data) {
		$.each(data,  function(index) {

	    var i;
            var j = 1;
            var location, min

            if (distance(lat,long,data.result[0][1],data.result[0][2]) < distance(lat,long,data.result[1][1],data.result[1][2])){

                min = distance(lat,long,data.result[0][1],data.result[0][2]);
                location = data.result[0][0];
                latend = data.result[0][1];
                longend = data.result[0][2];
		 }
            else {

                min = distance(lat,long,data.result[1][1],data.result[1][2]);
                location = data.result[1][0];
    		latend = data.result[1][1];
                longend = data.result[1][2];
	        }

            for (i = 2; i < 103; i++){
                if (min > distance(lat,long,data.result[i][1],data.result[i][2])){
                    min = distance(lat,long,data.result[i][1],data.result[i][2]);
                    location = data.result[i][0];
                    latend = data.result[i][1];
                    longend = data.result[i][2];
            }}

            var div = document.getElementById('test');
            div.innerHTML += "The closest location to " + address + " is " + location + ".";
            div.innerHTML += "You are " + min +"km away from " + location + ".<br>";
            startmap(lat, long, latend, longend)
        })
	})
	}
	

        function distance(lat1,lon1,lat2,lon2) {
            var R = 6371; // Radius of the earth in km
            var dLat = deg2rad(lat2-lat1);  // deg2rad below
            var dLon = deg2rad(lon2-lon1);
            var a =
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon/2) * Math.sin(dLon/2);

            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            var d = R * c; // Distance in km
            var result = Math.round(d*100)/100
            return result;
            }
            function deg2rad(deg) {
                return deg * (Math.PI/180)
            }
</script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCaLIaggqQb52Url971GbbnWc3XusmTukM&callback=myMap">
</script>

</body>
</html>
